# Estructura del Sub-Agente de WhatsApp
# ======================================
# Este archivo documenta todos los componentes del sub-agente

sub_agent_whatsApp/
â”‚
â”œâ”€â”€ ğŸ“„ __init__.py                    âœ… CREADO
â”œâ”€â”€ ğŸ“„ README.md                      âœ… CREADO
â”œâ”€â”€ ğŸ“„ config.py                      âœ… CREADO - ConfiguraciÃ³n completa
â”œâ”€â”€ ğŸ“„ state.py                       âœ… CREADO - Estado del agente
â”œâ”€â”€ ğŸ“„ graph.py                       â³ POR CREAR - Grafo principal de LangGraph
â”‚
â”œâ”€â”€ ğŸ“ nodes/                         # Nodos del grafo
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py                âœ… CREADO
â”‚   â”œâ”€â”€ ğŸ“„ classify_intent.py         âœ… CREADO - Clasificar intenciÃ³n
â”‚   â”œâ”€â”€ ğŸ“„ retrieve_context.py        â³ POR CREAR - RAG: Recuperar contexto
â”‚   â”œâ”€â”€ ğŸ“„ check_patient.py           â³ POR CREAR - Verificar si es paciente
â”‚   â”œâ”€â”€ ğŸ“„ handle_appointment.py      â³ POR CREAR - Gestionar agendamiento
â”‚   â”œâ”€â”€ ğŸ“„ handle_query.py            â³ POR CREAR - Responder consultas
â”‚   â”œâ”€â”€ ğŸ“„ handle_cancellation.py     â³ POR CREAR - Gestionar cancelaciones
â”‚   â”œâ”€â”€ ğŸ“„ escalate_human.py          â³ POR CREAR - Escalar a humano
â”‚   â””â”€â”€ ğŸ“„ generate_response.py       â³ POR CREAR - Generar respuesta final
â”‚
â”œâ”€â”€ ğŸ“ tools/                         # Herramientas del agente
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py                â³ POR CREAR
â”‚   â”œâ”€â”€ ğŸ“„ patient_tools.py           â³ POR CREAR - CRUD de pacientes
â”‚   â”‚   â”œâ”€â”€ search_patient()
â”‚   â”‚   â”œâ”€â”€ get_patient_info()
â”‚   â”‚   â”œâ”€â”€ create_patient()
â”‚   â”‚   â””â”€â”€ get_patient_history()
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“„ appointment_tools.py       â³ POR CREAR - GestiÃ³n de citas
â”‚   â”‚   â”œâ”€â”€ check_availability()
â”‚   â”‚   â”œâ”€â”€ book_appointment()
â”‚   â”‚   â”œâ”€â”€ cancel_appointment()
â”‚   â”‚   â”œâ”€â”€ reschedule_appointment()
â”‚   â”‚   â””â”€â”€ get_available_slots()
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“„ query_tools.py             â³ POR CREAR - Consultas de informaciÃ³n
â”‚   â”‚   â”œâ”€â”€ get_treatment_info()
â”‚   â”‚   â”œâ”€â”€ get_clinic_info()
â”‚   â”‚   â”œâ”€â”€ get_prices()
â”‚   â”‚   â””â”€â”€ search_faq()
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“„ rag_tools.py               â³ POR CREAR - Herramientas de RAG
â”‚       â”œâ”€â”€ retrieve_context()
â”‚       â”œâ”€â”€ index_conversation()
â”‚       â””â”€â”€ search_similar_conversations()
â”‚
â”œâ”€â”€ ğŸ“ utils/                         # Utilidades
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py                â³ POR CREAR
â”‚   â”œâ”€â”€ ğŸ“„ embeddings.py              â³ POR CREAR - Servicio de embeddings
â”‚   â”‚   â”œâ”€â”€ LocalEmbeddings class
â”‚   â”‚   â”œâ”€â”€ embed_text()
â”‚   â”‚   â””â”€â”€ embed_batch()
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“„ database.py                â³ POR CREAR - ConexiÃ³n a PostgreSQL
â”‚   â”‚   â”œâ”€â”€ get_db_connection()
â”‚   â”‚   â”œâ”€â”€ execute_query()
â”‚   â”‚   â””â”€â”€ execute_transaction()
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“„ vector_store.py            â³ POR CREAR - GestiÃ³n de pgvector
â”‚   â”‚   â”œâ”€â”€ VectorStore class
â”‚   â”‚   â”œâ”€â”€ add_documents()
â”‚   â”‚   â””â”€â”€ similarity_search()
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“„ metrics.py                 â³ POR CREAR - MÃ©tricas y logging
â”‚       â”œâ”€â”€ setup_logging()
â”‚       â”œâ”€â”€ setup_metrics()
â”‚       â””â”€â”€ track_conversation()
â”‚
â”œâ”€â”€ ğŸ“ tests/                         # Tests
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py                â³ POR CREAR
â”‚   â”œâ”€â”€ ğŸ“ nodes/                     # Tests de nodos
â”‚   â”‚   â”œâ”€â”€ test_classify_intent.py
â”‚   â”‚   â”œâ”€â”€ test_retrieve_context.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ tools/                     # Tests de herramientas
â”‚   â”‚   â”œâ”€â”€ test_patient_tools.py
â”‚   â”‚   â”œâ”€â”€ test_appointment_tools.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ integration/               # Tests de integraciÃ³n
â”‚   â”‚   â”œâ”€â”€ test_full_flow.py
â”‚   â”‚   â””â”€â”€ test_rag_integration.py
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ e2e/                       # Tests end-to-end
â”‚       â””â”€â”€ test_whatsapp_flow.py
â”‚
â””â”€â”€ ğŸ“ examples/                      # Ejemplos de uso
    â”œâ”€â”€ ğŸ“„ basic_usage.py             â³ POR CREAR
    â”œâ”€â”€ ğŸ“„ custom_config.py           â³ POR CREAR
    â””â”€â”€ ğŸ“„ testing_locally.py         â³ POR CREAR


# ============================================================================
# PRIORIDADES DE IMPLEMENTACIÃ“N
# ============================================================================

## FASE 1: Core (Semana 1) - CRÃTICO
1. âœ… state.py - Estado del agente
2. âœ… config.py - ConfiguraciÃ³n
3. â³ graph.py - Grafo principal
4. â³ utils/database.py - ConexiÃ³n a BD
5. â³ utils/embeddings.py - Servicio de embeddings

## FASE 2: Nodos BÃ¡sicos (Semana 2) - ALTA PRIORIDAD
6. âœ… nodes/classify_intent.py - ClasificaciÃ³n
7. â³ nodes/retrieve_context.py - RAG
8. â³ nodes/check_patient.py - VerificaciÃ³n de paciente
9. â³ nodes/generate_response.py - GeneraciÃ³n de respuesta
10. â³ nodes/escalate_human.py - Escalamiento

## FASE 3: Herramientas (Semana 3) - ALTA PRIORIDAD
11. â³ tools/patient_tools.py - Herramientas de pacientes
12. â³ tools/appointment_tools.py - Herramientas de citas
13. â³ tools/rag_tools.py - Herramientas de RAG
14. â³ utils/vector_store.py - GestiÃ³n de pgvector

## FASE 4: Nodos Avanzados (Semana 4) - MEDIA PRIORIDAD
15. â³ nodes/handle_appointment.py - GestiÃ³n de agendamiento
16. â³ nodes/handle_query.py - Responder consultas
17. â³ nodes/handle_cancellation.py - Cancelaciones
18. â³ tools/query_tools.py - Herramientas de consultas

## FASE 5: Testing y Refinamiento (Semana 5-6) - MEDIA PRIORIDAD
19. â³ tests/* - Suite completa de tests
20. â³ utils/metrics.py - MÃ©tricas y logging
21. â³ examples/* - Ejemplos de uso
22. â³ DocumentaciÃ³n adicional


# ============================================================================
# DEPENDENCIAS ENTRE COMPONENTES
# ============================================================================

graph.py
  â”œâ”€â”€ DEPENDE DE: state.py, config.py
  â”œâ”€â”€ DEPENDE DE: nodes/* (todos los nodos)
  â””â”€â”€ DEPENDE DE: utils/database.py (para checkpointer)

nodes/retrieve_context.py
  â”œâ”€â”€ DEPENDE DE: state.py, config.py
  â”œâ”€â”€ DEPENDE DE: tools/rag_tools.py
  â””â”€â”€ DEPENDE DE: utils/vector_store.py

nodes/check_patient.py
  â”œâ”€â”€ DEPENDE DE: state.py, config.py
  â””â”€â”€ DEPENDE DE: tools/patient_tools.py

nodes/handle_appointment.py
  â”œâ”€â”€ DEPENDE DE: state.py, config.py
  â”œâ”€â”€ DEPENDE DE: tools/appointment_tools.py
  â””â”€â”€ DEPENDE DE: tools/patient_tools.py

nodes/generate_response.py
  â”œâ”€â”€ DEPENDE DE: state.py, config.py
  â””â”€â”€ DEPENDE DE: LLM (Anthropic)

tools/rag_tools.py
  â”œâ”€â”€ DEPENDE DE: utils/embeddings.py
  â”œâ”€â”€ DEPENDE DE: utils/vector_store.py
  â””â”€â”€ DEPENDE DE: utils/database.py

tools/patient_tools.py
  â””â”€â”€ DEPENDE DE: utils/database.py

tools/appointment_tools.py
  â””â”€â”€ DEPENDE DE: utils/database.py

utils/vector_store.py
  â”œâ”€â”€ DEPENDE DE: utils/embeddings.py
  â””â”€â”€ DEPENDE DE: utils/database.py


# ============================================================================
# INTERFACES EXTERNAS
# ============================================================================

## Entrada (desde WhatsApp Webhook)
- Recibe: mensaje, nÃºmero, nombre del contacto
- Crea: estado inicial
- Ejecuta: graph.run(state)
- Retorna: respuesta generada

## Salida hacia Base de Datos
- Consultas: pacientes, citas, tratamientos, horarios
- Inserciones: mensajes, conversaciones, citas
- Actualizaciones: estado de conversaciones, citas

## Salida hacia pgvector (RAG)
- BÃºsquedas: similitud semÃ¡ntica de conversaciones
- Inserciones: indexaciÃ³n de nuevas conversaciones

## Salida hacia Frontend (API)
- Notificaciones: citas pendientes de confirmaciÃ³n
- Alertas: escalamientos a humano
- Actualizaciones: estado de conversaciones


# ============================================================================
# NOTAS DE IMPLEMENTACIÃ“N
# ============================================================================

1. MODULARIDAD
   - Cada componente debe ser independiente
   - Usar dependency injection donde sea posible
   - Evitar imports circulares

2. TESTING
   - Cada nodo debe tener tests unitarios
   - Cada herramienta debe tener tests de integraciÃ³n
   - El grafo completo debe tener tests e2e

3. LOGGING
   - Usar logging estructurado (JSON)
   - Incluir conversation_id en todos los logs
   - No loggear datos sensibles (nÃºmeros de telÃ©fono completos, etc.)

4. ERROR HANDLING
   - Todos los nodos deben manejar excepciones
   - En caso de error, escalar a humano
   - Mantener el estado consistente

5. PERFORMANCE
   - Usar async/await donde sea posible
   - Cachear embeddings cuando sea apropiado
   - Optimizar queries a la BD

6. SEGURIDAD
   - Validar todos los inputs
   - Sanitizar datos antes de guardar en BD
   - Rate limiting por contacto
   - Timeout de conversaciones inactivas
